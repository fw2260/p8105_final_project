---
title: "Linear Regression"
date: "2020/11/26"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(arsenal)
library(multcomp)
library(modelr)
library(mgcv)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot_cpntinuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Tidy the Data

## Import the Dataset

also do descriptive statistics

```{r include = F ,message = F}
games_data = read_csv("./data/games.csv")

box_plot = 
  games_data %>% 
  ggplot(aes(y = n_platforms)) +
  geom_boxplot()

ggplotly(box_plot)
```

```{r}
games_df = 
  games_data %>%
  mutate(
    period = 
      case_when(
        release_year >= '2001'& release_year <= '2005' ~ '2001-2005',
        release_year >= '2006'& release_year <= '2010' ~ '2006-2010',
        release_year >= '2011'& release_year <= '2015' ~ '2011-2015',
        release_year >= '2016'& release_year <= '2020' ~ '2016-2020'),
    period = as.factor(period)
    ) %>%
  mutate(
    genre = 
      case_when(
        genre %in% c('action','action_adventure',"adventure") ~ 'Action',
        genre %in% c('strategy','puzzle') ~ 'Intellegence',
        genre %in% c('racing','sports') ~ 'Competition',
        genre %in% c('miscellaneous','role_playing', 'simulation') ~ 'Experience',
        genre %in% c('platform', 'shooting')~ 'Agility')
    ) %>%
  mutate(
    n_platforms = 
      case_when(n_platforms == '3' ~ 'small',
                n_platforms >= '4' & n_platforms <= '6' ~ 'medium',
                n_platforms >= '7' ~ 'large'),
    n_platforms = as.factor(n_platforms)
    ) %>% 
  dplyr::select(title:genre, period, critic_score, total_sale) 
```


# Anova Test

## Period

```{r ANOVA_Period, include = F}
aov_mod_1 = aov(total_sale ~ period, data = games_df)
broom::tidy(aov_mod_1)

multicomp_1 = TukeyHSD(aov_mod_1)
plot(multicomp_1)
broom::tidy(multicomp_1)
```

Anova test indicates that at least two periods have different average total sales of video games. Multiple comparison by Tukey's method shows that significant differences exist in 2006-2010 vs 2001-2005, 2011-2015 vs 2001-2005, 2011-2015 vs 2006-2010, 2016-2020 vs 2011-2015.

Console_developers * Period

```{r ANOVA_Console_developers_period, include = F}
aov_mod_2 = aov(total_sale ~ console_developer * period, data = games_df)
broom::tidy(aov_mod_2)

multicomp_2 = TukeyHSD(aov_mod_2)

ori_df = 
  broom::tidy(multicomp_2) %>%
  filter(term == 'console_developer:period') %>%
  na.omit() 

multi_df = 
  ori_df %>%
  filter(adj.p.value < 0.05)
```

Considering interaction between console_developers and period (e.g. Nintendo developed less popular games in recent years while Sony maintained a relatively stable trend). The new ANOVA model and multi-comparison shows that significant difference exists in `r nrow(multi_df)` combinations among `r nrow(ori_df)` combinations of developers and period.

## Genre

```{r ANOVA_Genre, include = F}
aov_mod_3 = aov(total_sale ~ genre, data = games_df)
broom::tidy(aov_mod_3)

multicomp3 = TukeyHSD(aov_mod_3)
plot(multicomp3)
```

Genre * Console_developer

```{r}
aov_mod_4 = aov(total_sale ~ console_developer * genre, data = games_df)
broom::tidy(aov_mod_4)

multicomp_4 = TukeyHSD(aov_mod_4)

ori_df_2 = 
  broom::tidy(multicomp_4) %>%
  filter(term == 'console_developer:genre') %>%
  na.omit() 

multi_df_2 = 
  ori_df_2 %>%
  filter(adj.p.value < 0.05)
```


Anova test shows that there are significant differences of average total_sales between genre and 60% of comparisons in Tukey's method have signigicant differences. Also, considering interaction between console_developers and genre, the differences is still significant in anova model, with `r nrow(multi_df_2)` significant different combinations among `r nrow(ori_df_2)` combinations of developers and genre

## Number of Platforms

```{r include = F}
aov_mod_5 = aov(total_sale ~ n_platforms, data = games_df)
broom::tidy(aov_mod_5)

multi_comp_5 = TukeyHSD(aov_mod_5)
plot(multi_comp_5)
``` 

Anova test and multi-comparison shows that there are significant differences of average total_sales between number of platforms a game is released on. Significant difference occurs in comparisons of small and median n_platforms .

# Regression models

```{r regression dataset}
regression_df = games_df %>%
  filter(total_sale < 40) %>% # cutoff outliers
  dplyr::select(total_sale,genre,console_developer,period,critic_score,n_platforms,na_sale,japan_sale,pal_sale,other_sale)

```

## Model 1: Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms

```{r regresion_model_1}
lm1 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + 0, data = regression_df)
summary(lm1)
plot(lm1)
```

## Model 2: Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score 

```{r regression_modole_2}
lm2 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + 0, data = regression_df)
summary(lm2)
plot(lm2)
```

## Model 3: Total_sale ~ console_developer:genre + console_developer:n_platforms + console_developer:critic_score

```{r regression_modole_3}
lm3 = lm(total_sale ~ console_developer:genre + console_developer:n_platforms + console_developer:critic_score + 0, data = regression_df)
summary(lm3)
plot(lm3)
```

## Model 4 : Total_sale ~ console_developer: period + console_developer:genre +  console_developer:critic_score

```{r regression_modole_4}
lm4 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:critic_score + 0, data = regression_df)
summary(lm4)
plot(lm4)
```

## Decide what variable (period, critic_score, n_platform) can stay in the model, then consider if it's necessary to add some (but not all) regional sale into the model.

```{r regression_rmse_1}
cv_df = 
  crossv_mc(regression_df, 1000) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
  
  
cv_df = 
  cv_df %>% 
  mutate(
    linear_1 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + 0, data = .x)),
    linear_2 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + 0, data = .x)),
    linear_3 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:n_platforms + console_developer:critic_score + 0, data = .x)),
    linear_4 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:critic_score + 0, data = .x))
  ) %>% 
  mutate(
    rmse_1 = map2_dbl(.x = linear_1, .y = test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(.x = linear_2, .y = test, ~rmse(model = .x, data = .y)),
    rmse_3 = map2_dbl(.x = linear_3, .y = test, ~rmse(model = .x, data = .y)),
    rmse_4 = map2_dbl(.x = linear_4, .y = test, ~rmse(model = .x, data = .y))
  )
```


```{r regression_rmse_compare1234}
cv_df %>% 
  dplyr::select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin()
```

## Model 5 : Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + na_sale (delete unnecessary variables discovered above)

```{r regression_modole_5}
lm5 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + na_sale +0, data = regression_df)
summary(lm5)
plot(lm5)
```

## Model 6 : Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:na_sale (delete unnecessary variables discovered above)

```{r regression_modole_6}
lm6 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:na_sale + 0, data = regression_df)
summary(lm6)
plot(lm6)
```


```{r regression_rmse_2}
cv_df_else = 
  crossv_mc(regression_df, 1000) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
  
  
cv_df_else = 
  cv_df_else %>% 
  mutate(
    linear_5 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + na_sale +0, data = .x)),
    linear_6 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:na_sale + 0, data = .x)),
    linear_7 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + japan_sale + 0, data = .x))
    #linear_8 = map(.x = train, ~lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:japan_sale + 0, data = .x))
  ) %>% 
  mutate(
    rmse_5 = map2_dbl(.x = linear_5, .y = test, ~rmse(model = .x, data = .y)),
    rmse_6 = map2_dbl(.x = linear_6, .y = test, ~rmse(model = .x, data = .y)),
    rmse_7 = map2_dbl(.x = linear_7, .y = test, ~rmse(model = .x, data = .y))
    #rmse_8 = map2_dbl(.x = linear_8, .y = test, ~rmse(model = .x, data = .y))
  )
```


```{r regression_rmse_compare56}
cv_df_else %>% 
  dplyr::select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin()
```
