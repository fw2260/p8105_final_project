---
title: "anova + regression model"
author: "haoyang,yi"
date: "2020/11/26"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(arsenal)
library(multcomp)
library(dplyr)
```

```{r include = F ,message = F}
games_df = read_csv("./data/games.csv")
games_df = games_df %>%
  mutate(period = case_when(release_year >= '2001'& release_year <= '2005' ~ '2001-2005',
                            release_year >= '2006'& release_year <= '2010' ~ '2006-2010',
                            release_year >= '2011'& release_year <= '2015' ~ '2011-2015',
                            release_year >= '2016'& release_year <= '2020' ~ '2016-2020'),
         period = as.factor(period)) %>%
  mutate(genre = case_when(genre == 'action' ~ 'Action',
                           genre == 'action_adventure' ~ 'Action',
                           genre == 'adventure' ~ 'Action', 
                           genre == 'strategy' ~ 'Intellegence',
                           genre == 'puzzle' ~ 'Intellegence', 
                           genre == 'racing' ~ 'Competition',
                           genre == 'sports' ~ 'Competition', 
                           genre == 'miscellaneous' ~ 'Experience',
                           genre == 'role_playing' ~ 'Experience',
                           genre == 'simulation'~ 'Experience', 
                           genre == 'platform'~ 'Agility',
                           genre == 'shooting' ~ 'Agility')) %>%
  mutate(n_platforms = case_when(n_platforms <= '3' ~ 'small',
                                 n_platforms >= '4' & n_platforms <= '6' ~ 'median',
                                 n_platforms >= '7' ~ 'large',),as.factor(n_platforms)) 
```
## Anova test
# Period
```{r }
aovmodel1 = aov(total_sale ~ period, data = games_df)
broom::tidy(aovmodel1)
multicomp1 = TukeyHSD(aovmodel1)
plot(multicomp1)
broom::tidy(multicomp1)
```
Anova test indicates that least two periods have different average total_sales of video games. Multiple comparison by Tukey's method shows that significant differences exists in 2006-2010 vs 2001-2005, 2011-2015 vs 2001-2005, 2011-2015 vs 2006-2010, 2016-2020 vs 2011-2015.
# Console_developers * period

```{r }
aovmodel2 = aov(total_sale ~ console_developer * period, data = games_df)
broom::tidy(aovmodel2)
multicomp2 = TukeyHSD(aovmodel2)
ori_df = broom::tidy(multicomp2) %>%
  filter(term == 'console_developer:period') %>%
  na.omit() 
multi_df = broom::tidy(multicomp2) %>%
  filter(term == 'console_developer:period') %>%
  na.omit() %>%
  filter(adj.p.value < 0.05)
```
    Considering interaction between console_developers and period (eg. Nintendo develops less popular game in recent years while Sony maintain a relatively stable trend). The new anova model and multi-comparison shows that significant difference exists in `r nrow(multi_df)` combinations among `r nrow(ori_df)` combinations of developers and period

# Genre
```{r }
aovmodel3 = aov(total_sale ~ genre, data = games_df)
broom::tidy(aovmodel3)
multicomp3 = TukeyHSD(aovmodel3)
plot(multicomp3)
aovmodel4 = aov(total_sale ~ console_developer * genre, data = games_df)
broom::tidy(aovmodel4)
multicomp4 = TukeyHSD(aovmodel4)
ori2_df = broom::tidy(multicomp4) %>%
  filter(term == 'console_developer:genre') %>%
  na.omit() 
multi2_df = broom::tidy(multicomp4) %>%
  filter(term == 'console_developer:genre') %>%
  na.omit() %>%
  filter(adj.p.value < 0.05)
```
    Anova test shows that there are significant differences of average total_sales between genre and 60% of comparisons in Tukey's method have signigicant differences. Also, considering interaction between console_developers and genre, the differences is still significant in anova model, with `r nrow(multi2_df)` significant different combinations among `r nrow(ori2_df)` combinations of developers and genre

# Number of platforms
```{r }
aovmodel5 = aov(total_sale ~ n_platforms, data = games_df)
broom::tidy(aovmodel5)
multicomp5 = TukeyHSD(aovmodel5)
plot(multicomp5)
``` 
  Anova test and multi-comparison shows that there are significant differences of average total_sales between number of platforms a game is released on. Significant difference occurs in comparisons of small and median n_platforms .

## Regression models
# Model 1: Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms
```{r include = F}
regression_df = games_df %>%
  filter(total_sale < 40) %>% # cutoff outliers
  dplyr::select(total_sale,genre,console_developer,period,critic_score,n_platforms,na_sale,japan_sale,pal_sale,other_sale)
lm1 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + 0, data = regression_df)
summary(lm1)

```
# Model 2: Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score 
```{r include = F}
lm2 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + 0, data = regression_df)
summary(lm2)

```
# Model 3: Total_sale ~ console_developer:genre + console_developer:n_platforms + console_developer:critic_score
```{r include = F}
lm3 = lm(total_sale ~ console_developer:genre + console_developer:n_platforms + console_developer:critic_score + 0, data = regression_df)
summary(lm3)

```
# Model 4 : Total_sale ~ console_developer: period + console_developer:genre +  console_developer:critic_score
```{r include = F}
lm4 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:critic_score + 0, data = regression_df)
summary(lm4)

```
# Decide what variable (period, critic_score, n_platform) can stay in the model, then consider if it's necessary to add some (but not all) regional sale into the model.


# Model 5 : Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + na_sale (delete unnecessary variables discovered above)
```{r include = F}
lm5 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + na_sale +0, data = regression_df)
summary(lm5)

```
# Model 6 : Total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:na_sale (delete unnecessary variables discovered above)
```{r include = F}
lm6 = lm(total_sale ~ console_developer:genre + console_developer:period + console_developer:n_platforms + console_developer:critic_score + console_developer:na_sale + 0, data = regression_df)
summary(lm6)

```